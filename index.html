<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SVG Clone Stress + Mutation + Reinsertion</title>
  <style>
    body { background: #fff; margin: 0; padding: 0; font-family: sans-serif; }
    svg { width: 100vw; height: 100vh; display: block; border: 2px solid black; }
  </style>
</head>
<body>
  <svg id="svg" viewBox="-1000 -1000 2000 2000" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
      <g id="complex">
        <rect x="-50" y="-50" width="100" height="100" fill="red" stroke="black" stroke-width="4"/>
        <circle cx="0" cy="0" r="30" fill="blue" />
        <path d="M -40,-40 Q 0,-80 40,-40 T 40,40" fill="none" stroke="green" stroke-width="3"/>
        <text x="-40" y="60" font-size="12" fill="purple">Test</text>
      </g>
    </defs>
  </svg>
  <script>
    const svg = document.getElementById('svg');
    let iteration = 0;
    let clones = [];

    function stressCloneWithReinsertion() {
      const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
      use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#complex');

      const tx = Math.random() * 2000 - 1000;
      const ty = Math.random() * 2000 - 1000;
      const scale = 0.5 + Math.random() * 2;
      const rotate = Math.random() * 360;
      use.setAttribute('transform', `translate(${tx},${ty}) scale(${scale}) rotate(${rotate})`);

      svg.appendChild(use);
      clones.push(use);

      try {
        const bbox = use.getBBox();
        console.log(`[${iteration}] BBox:`, bbox);
      } catch (e) {
        console.warn(`[${iteration}] getBBox failed:`, e);
      }

      if (iteration % 5 === 0) {
        const rect = svg.querySelector('#complex rect');
        rect.setAttribute('width', 100 + Math.random() * 200);
        rect.setAttribute('height', 100 + Math.random() * 200);
        console.log(`[${iteration}] Mutated <rect>`);
      }

      if (iteration % 15 === 0 && clones.length > 0) {
        const victim = clones.shift();
        svg.removeChild(victim);
        // Reinserir em novo local
        victim.setAttribute('transform', `translate(${Math.random()*2000-1000},${Math.random()*2000-1000}) scale(${0.5+Math.random()*2}) rotate(${Math.random()*360})`);
        svg.appendChild(victim);
        clones.push(victim);
        console.log(`[${iteration}] Reinseriu clone mutado`);
      }

      iteration++;
      if (iteration < 400) requestAnimationFrame(stressCloneWithReinsertion);
    }

    stressCloneWithReinsertion();
  </script>
</body>
</html>
