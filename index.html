<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SVG Deep Mutation Test</title>
  <style>
    body { margin: 0; padding: 0; background: #fff; }
    svg { width: 100vw; height: 100vh; display: block; border: 2px solid black; }
  </style>
</head>
<body>
  <svg id="svg" viewBox="-1000 -1000 2000 2000" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs id="defs">
      <g id="complexA">
        <rect x="-50" y="-50" width="100" height="100" fill="red" stroke="black" stroke-width="4"/>
        <circle cx="0" cy="0" r="30" fill="blue" />
        <path d="M -40,-40 Q 0,-80 40,-40 T 40,40" fill="none" stroke="green" stroke-width="3"/>
        <text x="-40" y="60" font-size="12" fill="purple">Test A</text>
      </g>
      <g id="complexB">
        <rect x="-60" y="-60" width="120" height="120" fill="orange" stroke="black" stroke-width="4"/>
        <circle cx="0" cy="0" r="25" fill="navy" />
        <text x="-50" y="70" font-size="12" fill="brown">Test B</text>
      </g>
    </defs>
  </svg>
  <script>
    const svg = document.getElementById('svg');
    const defs = document.getElementById('defs');
    let iteration = 0;
    let clones = [];
    let toggle = false;

    function mutateDefsSwap() {
      const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
      const refId = toggle ? '#complexA' : '#complexB';
      use.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', refId);

      const tx = Math.random() * 2000 - 1000;
      const ty = Math.random() * 2000 - 1000;
      const scale = 0.4 + Math.random() * 1.5;
      const rotate = Math.random() * 360;
      use.setAttribute('transform', `translate(${tx},${ty}) scale(${scale}) rotate(${rotate})`);

      svg.appendChild(use);
      clones.push(use);

      try {
        const bbox = use.getBBox();
        console.log(`[${iteration}] BBox:`, bbox);
      } catch (e) {
        console.warn(`[${iteration}] getBBox failed:`, e);
      }

      if (iteration % 10 === 0 && defs) {
        toggle = !toggle;
        const target = toggle ? defs.querySelector('#complexA') : defs.querySelector('#complexB');
        const rect = target.querySelector('rect');
        rect.setAttribute('width', 100 + Math.random() * 100);
        rect.setAttribute('height', 100 + Math.random() * 100);
        console.log(`[${iteration}] Mutated rect in ${target.id}`);
      }

      if (iteration % 25 === 0) {
        const toRemove = defs.querySelector(toggle ? '#complexB' : '#complexA');
        defs.removeChild(toRemove);
        setTimeout(() => defs.appendChild(toRemove), 50);
        console.log(`[${iteration}] Temporarily removed and reinserted ${toRemove.id}`);
      }

      iteration++;
      if (iteration < 400) requestAnimationFrame(mutateDefsSwap);
    }

    mutateDefsSwap();
  </script>
</body>
</html>
