<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SVG Shadow Tree UAF Test</title>
  <style>
    body {
      background: white;
      margin: 0;
    }
    svg {
      width: 100%;
      height: 100vh;
      display: block;
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <h2>SVG Use + Shadow Tree Test</h2>
  <svg id="svg" viewBox="0 0 100 100">
    <defs>
      <g id="target">
        <rect x="0" y="0" width="10" height="10" fill="red" />
      </g>
    </defs>
    <use id="use" href="#target" x="10" y="10" />
  </svg>

  <script>
    const svg = document.getElementById("svg");
    const use = document.getElementById("use");
    const defs = svg.querySelector("defs");
    const target = document.getElementById("target");

    let counter = 0;

    function stress() {
      try {
        // Remove e reinsere o <g> usado por <use>
        defs.removeChild(target);
        defs.appendChild(target);

        // Alterna o href dinamicamente
        use.setAttribute("href", "");
        use.setAttribute("href", "#target");

        // Força leitura de propriedades que causam reconstrução interna
        use.transform.baseVal; // pode forçar rebuild no WebKit
        use.getBBox();         // leitura que interage com shadow tree
      } catch (e) {}

      counter++;
      if (counter < 10000) {
        requestAnimationFrame(stress);
      }
    }

    requestAnimationFrame(stress);
  </script>
</body>
</html>
