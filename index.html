<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Type Confusion via JIT</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: monospace;
      padding: 20px;
    }
    #log {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>JIT Type Confusion Test</h1>
  <div id="log">Carregando gadget...</div>

  <script>
    const logElement = document.getElementById("log");
    let logs = "";

    function log(msg) {
      logs += msg + "\n";
      logElement.textContent = logs;
    }

    function runGadget() {
      let arr = [1.1, 2.2, 3.3, 4.4];
      let obj = {x: 1337};

      function confuse(a, i) {
        return a[i];
      }

      for (let i = 0; i < 100000; i++) confuse(arr, 0); // aquece JIT

      // Troca por objeto apÃ³s JIT otimizar como "contendo doubles"
      arr[0] = obj;

      let res = confuse(arr, 0); // espera double, recebe objeto
      log("[gadget-typeconf] Resultado: " + res);
      log("[gadget-typeconf] typeof: " + typeof res);
    }

    setTimeout(() => {
      log("Iniciando gadget de Type Confusion via JIT...");
      runGadget();
      log("Finalizado.");
    }, 1000);
  </script>
</body>
</html>
