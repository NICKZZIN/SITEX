<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SVG Corruption Detection PoC</title>
  <style>
    body {
      background: #fff;
      color: #000;
      font-family: sans-serif;
    }
    svg {
      border: 2px solid red;
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <h2>SVG cloneNode + transform + detection</h2>
  <p>Se a renderização ou os dados das caixas estiverem corrompidos, isso pode indicar corrupção de memória no WebKit.</p>

  <svg id="svgRoot" width="2000" height="2000" viewBox="-2000 -2000 4000 4000">
    <defs>
      <rect id="baseRect" x="0" y="0" width="40" height="40" fill="red"/>
    </defs>
  </svg>

  <div id="log" style="white-space: pre; font-size: 14px; padding: 1em;"></div>

  <script>
    const svg = document.getElementById("svgRoot");
    const base = document.getElementById("baseRect");
    const clones = [];
    const logDiv = document.getElementById("log");

    function log(msg) {
      logDiv.textContent = msg + "\n" + logDiv.textContent;
    }

    // Cria muitos clones com transformações
    for (let i = 0; i < 100; i++) {
      const clone = base.cloneNode();
      const tx = Math.random() * 3000 - 1500;
      const ty = Math.random() * 3000 - 1500;
      const rot = Math.random() * 360;
      const sc = 0.5 + Math.random() * 2.5;
      clone.setAttribute("transform", `translate(${tx}, ${ty}) rotate(${rot}) scale(${sc})`);
      svg.appendChild(clone);
      clones.push(clone);
    }

    // Verificação periódica de integridade das caixas
    function checkIntegrity() {
      for (let i = 0; i < clones.length; i++) {
        const el = clones[i];
        try {
          const box = el.getBBox();
          const rect = el.getBoundingClientRect();

          // Checa se valores estão estranhos ou impossíveis
          if (
            box.width <= 0 || box.height <= 0 ||
            isNaN(box.x) || isNaN(box.y) ||
            rect.width <= 0 || rect.height <= 0 ||
            Math.abs(rect.width) > 5000 || Math.abs(rect.height) > 5000
          ) {
            log(`Anomalia detectada no elemento #${i}:`);
            log(`BBox: x=${box.x}, y=${box.y}, w=${box.width}, h=${box.height}`);
            log(`ClientRect: w=${rect.width}, h=${rect.height}`);
          }
        } catch (e) {
          log(`Erro ao acessar box de #${i}: ${e.message}`);
        }
      }

      requestAnimationFrame(checkIntegrity);
    }

    checkIntegrity();
  </script>
</body>
</html>
