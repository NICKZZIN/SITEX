<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SVG xlink:href Stress Test</title>
  <style>
    body { background: #fff; font-family: sans-serif; }
    svg { border: 2px solid #000; margin: 10px; display: block; }
  </style>
</head>
<body>
  <h1>Teste de Estresse com &lt;use&gt; e xlink:href</h1>
  <svg id="svg" width="800" height="800" viewBox="-1000 -1000 2000 2000" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
      <g id="target">
        <rect x="-10" y="-10" width="20" height="20" fill="blue"/>
      </g>
    </defs>
  </svg>
  <script>
    const svg = document.getElementById("svg");

    const count = 120;
    let iteration = 0;

    function addUseElement(i) {
      const use = document.createElementNS("http://www.w3.org/2000/svg", "use");

      // Alterna entre xlink válido, inválido e vazio
      if (i % 3 === 0) {
        use.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "#target");
      } else if (i % 3 === 1) {
        use.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "#nonexistent" + Math.random());
      } else {
        use.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", "");
      }

      use.setAttribute("transform", `translate(${Math.random()*2000-1000}, ${Math.random()*2000-1000}) rotate(${Math.random()*360}) scale(${Math.random()*5})`);
      svg.appendChild(use);

      // Remove depois de um tempo
      setTimeout(() => svg.removeChild(use), 500);
    }

    function stress() {
      for (let i = 0; i < count; i++) addUseElement(i);
      iteration++;
      console.log(`[xlink:use] Iteration ${iteration}`);
      if (iteration < 300) requestAnimationFrame(stress);
    }

    stress();
  </script>
</body>
</html>
